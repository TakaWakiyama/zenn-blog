---
title: "Pub/Subã‚’ä½¿ã„CloudBuildã®å®Ÿè¡Œçµæœã‚’Slackã«é€šçŸ¥ã™ã‚‹ã€‚"
emoji: "ğŸ˜½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["CloudBuild", "GCP", "Pub/Sub"]
published: true
---

# ã¯ã˜ã‚ã«

CloudBuild ã®å®Ÿè¡Œå®Œäº†çµæœã‚’Slackã¸é€šçŸ¥ã—ãŸæ™‚ã®å‚™å¿˜éŒ²ã‚’æ›¸ãã¾ã™ã€‚
æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã«Slacké€šçŸ¥ã‚’è¡Œã†ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€

* è¤‡æ•°ã®cloudbuildãƒˆãƒªã‚¬ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œãã‚Œã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã«åŒã˜å‡¦ç†ã‚’æ›¸ãã®ã¯å†—é•·ã«ãªã‚‹
* Buildã¨é€šçŸ¥ã‚’åˆ†é›¢ã—ãªã„ã¨é€šçŸ¥ã®å¤‰æ›´ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã«å½±éŸ¿ã‚’ä¸ãˆã¦ã—ã¾ã†

ãŸã‚æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãæ›ãˆãªã„æ–¹é‡ã§é€šçŸ¥ã‚’å®Ÿç¾ã§ããªã„ã‹èª¿æŸ»ã—ã¾ã—ãŸã€‚

https://kumaaaaa.com/slack-notifications-for-cloud-build

ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’è¦‹ã¤ã‘ãŸã®ã§ã€è¨˜äº‹ã«å¾“ã£ã¦æ§‹ç¯‰ã—ã¾ã—ãŸã€‚
ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸç‚¹ã«çµã£ã¦ã€èª¬æ˜ã‚’è¨˜è¼‰ã—ã¦ã„ãã¾ã™ã€‚

ç’°å¢ƒæ§‹ç¯‰ã«å¿…è¦ãªé …ç›®ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

* Cloud Build, Compute Engine, Cloud Run, Pub/Sub, and Secret Manager API ãŒæœ‰åŠ¹åŒ–ã•ã‚ŒãŸGCPç’°å¢ƒ
    [æœ‰åŠ¹åŒ–ã¯ã“ã¡ã‚‰](https://console.cloud.google.com/flows/enableapi?apiid=cloudbuild.googleapis.com,compute.googleapis.com,run.googleapis.com,pubsub.googleapis.com,secretmanager.googleapis.com&redirect=https://cloud.google.com/build/docs/configuring-notifications/configure-slack&_ga=2.38096868.618912976.1657631679-751121569.1646462434&_gac=1.151042379.1656933528.Cj0KCQjwn4qWBhCvARIsAFNAMigtCkzrpha4kEt_frm_DYrN19yVPc9n0wd3j9b-zZOTMKCnTVgFgxEaAuxKEALw_wcB)

* [Google Cloud CLI](https://cloud.google.com/sdk)
* Webhookè¨­å®šã®æ¸ˆã‚“ã  Slackãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹

## æ¦‚è¦

1. ãƒˆãƒªã‚¬ãƒ¼ã«å¿œã˜ã¦CloudBuildã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹
1. ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Ÿè¡ŒãŒçµ‚äº†ã™ã‚‹
1. Pub/Sub ã¸ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œçµ‚äº†ãŒPushã•ã‚Œã‚‹
1. Pub/Sub ã®ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œçµ‚äº†ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã—ã¦ã„ã‚‹CloudRunãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã™ã‚‹
1. å—ä¿¡ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã«å¿œã˜ã¦Slackã¸é€šçŸ¥ã‚’è¡Œã†

æ³¨æ„äº‹é …ã¨ã—ã¦CloudBuildã§ä½¿ç”¨ã•ã‚Œã‚‹ Pub/Subã®ãƒˆãƒ”ãƒƒã‚¯åã¯ `cloud-builds` ã¨å›ºå®šã•ã‚Œã¦ã„ã¾ã™ã€‚

å„ã‚µãƒ¼ãƒ“ã‚¹ãŒå…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªå½¹å‰²ã‚’æ‹…ã£ã¦ã„ã‚‹ã‹ã¯ä¸‹è¨˜ã®è¨˜äº‹ãŒåˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã®ã§ã€å‚ç…§ãã ã•ã„ã€‚

https://exlair.net/cloudbuild-and-cloudrun-with-slacknotifier

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

GCPã®å…¬å¼ã«ã‚ˆã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€
ã“ã¡ã‚‰ã‚’ä½¿ã£ã¦æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚
[ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰](https://github.com/GoogleCloudPlatform/cloud-build-notifiers)

[ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚](https://kumaaaaa.com/slack-notifications-for-cloud-build/)

## ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```yaml cloudbuild-notifiers/slack/slack.yaml
apiVersion: cloud-build-notifiers/v1
kind: SlackNotifier
metadata:
  name: example-slack-notifier
spec:
  notification:
    filter: true
  secrets:
  - name: webhook-url
    value:
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã® filter ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®ç¨®é¡ã‚’ä½•ç¨®é¡ã‹è¨˜è¼‰ã—ã¾ã™ã€‚
ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã¯ã€€[Slack é€šçŸ¥ã‚’æ§‹æˆã™ã‚‹](https://cloud.google.com/build/docs/configuring-notifications/configure-slack#filtering_by_trigger_id)ã€€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

* **ãƒˆãƒªã‚¬ãƒ¼ID ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**

ä»¥ä¸‹ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€æŒ‡å®šã—ãŸãƒˆãƒªã‚¬ãƒ¼ã®ã¿ã§é€šçŸ¥ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
**ãƒˆãƒªã‚¬ã®åç§°ã§ã¯ãªãã€IDã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„**

```yaml
filter: build.build_trigger_id == trigger-id
```

ã¾ãŸãƒˆãƒªã‚¬ãƒ¼ã®IDã¯

```sh
gcloud beta builds triggers list |grep -E '^(id|name|---)'
```

ã§å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

* **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**

Buildã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã£ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
ã¾ãŸ `in` ã‚’ä½¿ã£ã¦è¤‡æ•°ã®çŠ¶æ…‹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

```yaml
filter: build.status == Build.Status.SUCCESS && build.build_trigger_id == trigger-id
filter: build.status in [Build.Status.FAILURE, Build.Status.TIMEOUT]
```

* **ã‚¿ã‚°ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**

`build.tags` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ãƒˆãƒªã‚¬ãƒ¼ã«ç´ã¥ãã‚¿ã‚°ã§
ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```yaml
filter: tag-name in build.tags
```

* **å¤‰æ•°ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**

`build.substitutions`ã‚’ä½¿ã†ã“ã¨ã§æŸ”è»Ÿãªãƒ•ã‚£ãƒ«ã‚¿ã‚’è¡Œã†ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```yaml
filter: build.substitutions[substitution-variable] == substitution-value
build.substitutions["BRANCH_NAME"] == "main"
```

## ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¯å‘³æ°—ãªã„ã“ã¨ã‚„ã©ã®ãƒˆãƒªã‚¬ãƒ¼ãŒå®Ÿè¡Œã•ã‚ŒãŸçµæœãªã®ã‹
URLã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¦‹ã«è¡Œã‹ãªã„ã¨ã„ã‘ãªã„ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã—ãŸã€‚

ãƒªãƒã‚¸ãƒˆãƒªã®ä¸­ã‚’è¦‹ã‚‹ã¨

https://github.com/GoogleCloudPlatform/cloud-build-notifiers/blob/master/slack/main.go#L101

`writeMessage`é–¢æ•°ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œã‚‹å‡¦ç†ã‚’ã—ã¦ã„ã‚‹ã®ã§ã€ã‚¢ãƒ¬ãƒ³ã‚¸ã—ã¦ã„ãã¾ã™ã€‚
è¤‡æ•°ãƒˆãƒªã‚¬ãŒã‚ã‚‹ + è¤‡æ•°ã®ãƒ–ãƒ©ãƒ³ãƒã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã‚‹ã®ã§ã€
ãƒˆãƒªã‚¬åã¨ãƒ–ãƒ©ãƒ³ãƒåã‚’é€šçŸ¥å†…å®¹ã«å«ã‚ã¾ã™ã€‚

```diff go
func (s *slackNotifier) writeMessage() (*slack.WebhookMessage, error) {
+ subs := build.Substitutions

+ triggerName := ""
+if val, ok := subs["TRIGGER_NAME"]; ok {
+    triggerName = val
+}
+
+var branch string
+if val, ok := subs["BRANCH_NAME"]; ok {
+    branch = val
+}
+
+txt := fmt.Sprintf(
+    "Cloud Build ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n trigger: %s \n branch: %s \n status: +%s",
+    triggerName,
+    branch,
+    build.Status,
+)

---
+ atch := slack.Attachment{
+     Text:  txt
```

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ãŒå®Œäº†ã—ãŸã‚‰å†åº¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œãªã£ã¦ã„ãã¾ã™ã€‚

ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã« Buildã¨ gcrã¸ã®pushã‚’è¿½åŠ ã§å®Ÿè¡Œã—ã¾ã™ã€‚

https://github.com/GoogleCloudPlatform/cloud-build-notifiers/blob/a7045a46ea763837f6af68838a16cb05a91fee24/setup.sh#L88:L97

```diff yaml
- IMAGE_PATH="us-east1-docker.pkg.dev/gcb-release/cloud-build-notifiers/${NOTIFIER_TYPE}:latest"
+ IMAGE_PATH="asia.gcr.io/${PROJECT_ID}/notifier:latest"
}
```

https://github.com/GoogleCloudPlatform/cloud-build-notifiers/blob/a7045a46ea763837f6af68838a16cb05a91fee24/setup.sh#L159:L165

```diff yaml
deploy_notifier() {
+ docker build . -t ${IMAGE_PATH} --platform linux/amd64 -f "./slack/Dockerfile"
+ docker push ${IMAGE_PATH}
  gcloud run deploy "${SERVICE_NAME}" \
    --image="${IMAGE_PATH}" \
    --no-allow-unauthenticated \
+    --max-instances=1 \
    --update-env-vars="CONFIG_PATH=${DESTINATION_CONFIG_PATH},PROJECT_ID=${PROJECT_ID}" ||
    fail "failed to deploy notifier service -- check service logs for configuration error"
}
```

å†åº¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€æº–å‚™å®Œäº†ã§ã™!

```sh
bash ./setup.sh slack ./slack/slack.yaml
```

å®Ÿéš›ã«é€šçŸ¥ã™ã‚‹ã¨ç”»åƒã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼

[](/images/04e9d7d8062a36/acbvava04.png)

### è£œè¶³

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹ã®ã¯ã‚ã¾ã‚Šè‰¯ã„è§£æ±ºç­–ã§ã¯ãªã„ã¨æ€ã†ã®ã§ã€`filter`ã¨åŒã˜ã‚ˆã†ã«
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œã£ã¦ã€åŸ‹ã‚è¾¼ã¿ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã„ã†ã®ãŒè‰¯ã„ä¿®æ­£æ–¹æ³•ã§ã‚ã‚‹ã‹ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚
[Issue](https://github.com/GoogleCloudPlatform/cloud-build-notifiers/issues/32) ã«ã‚‚ã‚ã‚‹ã®ã§ã€ãƒˆãƒ©ã‚¤ã—ãŸã„æ°—æŒã¡ã‚‚ã‚ã‚Šã¾ã™ã€‚

## ã‚€ã™ã³ã«

sweeepã§ã¯ä¸€ç·’ã«åƒãã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ï¼
è‡ªå‹•åŒ–å¤§å¥½ã!ã‚¤ãƒ³ãƒ•ãƒ©åŠ¹ç‡åŒ–ã—ãŸã„ï¼æŠ€è¡“å¤§å¥½ãï¼
ãªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ–¹ä¸€ç·’ã«åƒãã¾ã—ã‚‡ã†ï¼

https://corp.sweeep.ai/recruit


## å‚è€ƒ
åŸ·ç­†ã«ã‚ãŸã‚Šä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚å¤§å¤‰åŠ©ã‹ã‚Šã¾ã—ãŸã€‚
https://cloud.google.com/build/docs/configuring-notifications/configure-slack#filtering_by_status

https://kumaaaaa.com/slack-notifications-for-cloud-build

https://exlair.net/cloudbuild-and-cloudrun-with-slacknotifier/
