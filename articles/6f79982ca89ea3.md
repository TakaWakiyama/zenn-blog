---
title: "外部サービス提供のAPIを叩く時に気をつけていること"
emoji: "🐡"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["API"]
published: false
---

# はじめに

外部サービスが提供しているWebAPIを利用して、自社サービスのシステム機能を作成する事も少なくないと思います。
サーバーサイドで外部APIを叩く経験が何回かあったので、
開発後に気づいたことなどを踏まえて設計・実装・運用上で気をつけていることを書いていきます。
自社で利用しているサービスのAPIを叩く話よりはエンドユーザの(OAuth2やOpenID Connectを利用)リソースに対して操作するケースの話を多めにします。

## 設計面

### ドキュメントを読み込む

基本的な事だと思いますが、利用サービスが提供しているAPIのリファレンスを読み込むことは重要です。
`RateLimit`やエンドユーザの利用プランに応じて挙動が変わるというのは細かい所に記載されていたりするので、
細かい制限をドキュメントから探す癖をつけるのがお勧めです。
またモデルの制約についても事前にドキュメントを確認した方が良いです。
例えば `nullable`かどうか自社のモデルと比べて文字数や数値の境界の制限が厳しくないかなどです。
基本的なインターフェースのみではなく、細かい制限事項などもドキュメントから読み取りましょう。

### 実際にサービスを利用して、挙動を確かめてみる

利用サービスに詳しい人が社内にいる場合でも、サービスを利用して仕様を確認することで考慮もれを防ぐ可能性が上がります。
特定の操作をした後のプロパティの状態のパターンを確認できることや
リソースの集合に対する制約(ユニーク制約)や作成上限などの確認を実装前に手早くできるので、
実装前に軽くサービスを操作することをお勧めします。
また、ドキュメントやサービスの挙動で不明点があれば、気軽にお問合せ窓口から連絡するとリードタイムが短縮できます。

### 連携解除の仕様を決めておく

連携解除の機能を提供した方が、ユーザは安心してシステムを利用できると思います。
連携解除の機能を提供するかどうか、提供する場合はデータの破棄を行うかなど対応する範囲や仕様を予め決めておいた方が
実装、運用時の対応工数が減ります。

## 実装面

### Open API ツールを利用してコード生成ができるか確認する

### トークンの保管と運用

### トランザクション管理

### テストコード

* Mock

* 実際に動くテスト

## 運用面

### ログを取る

### メンテナンス情報を定期的にWatchしておく

### タイムアウトとリトライ処理

    * トークンのリフレッシュ時の排他処理

## 終わりに

単純にAPIを動かすだけなら、数時間も掛からずに動かすことはできますが
実際の運用まで見越すと考慮すべき事項が多くシステムの複雑性が増したり、
リリース後のメンテナンスコストが結構掛かるという印象です。
提供する側
Webhookなどで、外部サービスからリクエストを受けるときの注意事項などについても今後書いていきたいです。